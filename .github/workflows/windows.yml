name: Build Windows EXE

on:
    push:
        branches: [master]
    pull_request:

jobs:
    build-windows:
        runs-on: windows-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install MSYS2 + GTK4
              uses: msys2/setup-msys2@v2
              with:
                  update: true
                  install: >
                      mingw-w64-x86_64-toolchain
                      mingw-w64-x86_64-gtk4
                      mingw-w64-x86_64-pkgconf
                      mingw-w64-x86_64-rust
                      pkg-config

            - name: Add MSYS2 to PATH
              shell: bash
              run: |
                  echo "C:/msys64/mingw64/bin" >> $GITHUB_PATH

            - name: Build (release)
              shell: msys2 {0}
              env:
                  PKG_CONFIG_ALLOW_CROSS: 1
              run: |
                  cargo build --release --target x86_64-pc-windows-gnu

            - name: Bundle GTK runtime
              shell: msys2 {0}
              run: |
                  mkdir -p bundle
                  cp target/x86_64-pc-windows-gnu/release/*.exe bundle/

                  # DLLs
                  cp /mingw64/bin/*.dll bundle/

                  # GTK runtime folders
                  mkdir -p bundle/share
                  cp -r /mingw64/share/glib-2.0 bundle/share/
                  cp -r /mingw64/share/icons bundle/share/
                  cp -r /mingw64/share/locale bundle/share/

                  mkdir -p bundle/lib
                  cp -r /mingw64/lib/gdk-pixbuf-2.0 bundle/lib/
                  cp -r /mingw64/lib/gtk-4.0 bundle/lib/

            - name: Upload bundle
              uses: actions/upload-artifact@v4
              with:
                  name: windows-bundle
                  path: bundle
